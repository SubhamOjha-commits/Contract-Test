name: Provider Verification Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'provider-service/**'
      - '.github/workflows/provider-verification-tests.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'provider-service/**'
  # Trigger when new PACT is published (webhook from Pact Broker)
  repository_dispatch:
    types: [pact-changed]

jobs:
  provider-verification:
    name: Verify Provider Contracts
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Cache Maven packages
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Download PACT files from Consumer
        run: |
          mkdir -p provider-service/target/pacts
          # In real scenario, download from Pact Broker
          # For now, we'll use local pacts from consumer
          if [ -d "consumer-service/target/pacts" ]; then
            cp consumer-service/target/pacts/*.json provider-service/target/pacts/ || true
          fi

      - name: Run Provider Verification Tests
        run: |
          cd provider-service
          mvn clean test -Dtest=*ProviderPactTest
        env:
          PACT_BROKER_URL: ${{ secrets.PACT_BROKER_URL || 'http://localhost:9292' }}
          PACT_PROVIDER_VERSION: ${{ github.sha }}

      - name: Publish Verification Results to Broker
        if: always()
        run: |
          echo "Publishing verification results to Pact Broker"
          # Results are automatically published by Pact JVM
        continue-on-error: true

      - name: Generate Test Report
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Provider Verification Test Results
          path: provider-service/target/surefire-reports/*.xml
          reporter: java-junit
          fail-on-error: true

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: provider-verification-results
          path: provider-service/target/surefire-reports/
          retention-days: 30

      - name: Comment PR with Verification Status
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}' === 'success' ? 'âœ… PASSED' : 'âŒ FAILED';
            const summary = `### ðŸ” Provider Verification Tests ${status}
            
            Provider verification against consumer contracts completed.
            
            ðŸ“Š View detailed results in the [test report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            ðŸ”— View in [Pact Broker](${{ secrets.PACT_BROKER_URL || 'http://localhost:9292' }})
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

  compatibility-check:
    name: Cross-Version Compatibility Check
    needs: provider-verification
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Pact CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/pact-foundation/pact-ruby-standalone/master/install.sh | bash
          echo "$HOME/pact/bin" >> $GITHUB_PATH

      - name: Check Compatibility Matrix
        run: |
          pact-broker can-i-deploy \
            --pacticipant UserProvider \
            --version ${{ github.sha }} \
            --to-environment production \
            --broker-base-url ${{ secrets.PACT_BROKER_URL || 'http://localhost:9292' }}
        continue-on-error: true

