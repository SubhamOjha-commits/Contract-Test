name: PACT Full Contract Testing Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  setup-pact-broker:
    name: Setup Pact Broker (Local)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start Pact Broker with Docker Compose
        run: |
          docker-compose up -d
          echo "Waiting for Pact Broker to be ready..."
          timeout 60 bash -c 'until curl -f http://localhost:9292/diagnostic/status/heartbeat; do sleep 2; done'

      - name: Verify Pact Broker is running
        run: |
          curl -f http://localhost:9292/diagnostic/status/heartbeat
          echo "âœ… Pact Broker is ready!"

  consumer-tests:
    name: Consumer Contract Tests
    needs: setup-pact-broker
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build Parent POM
        run: mvn clean install -DskipTests

      - name: Run Consumer Tests
        run: |
          cd consumer-service
          mvn clean test

      - name: Upload PACT Contracts
        uses: actions/upload-artifact@v3
        with:
          name: pact-contracts
          path: consumer-service/target/pacts/*.json

  provider-verification:
    name: Provider Verification Tests
    needs: consumer-tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Download PACT Contracts
        uses: actions/download-artifact@v3
        with:
          name: pact-contracts
          path: consumer-service/target/pacts

      - name: Build Parent POM
        run: mvn clean install -DskipTests

      - name: Run Provider Verification
        run: |
          cd provider-service
          mvn clean test

      - name: Upload Verification Results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: verification-results
          path: provider-service/target/surefire-reports/

  contract-compatibility-report:
    name: Generate Compatibility Report
    needs: [consumer-tests, provider-verification]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Artifacts
        uses: actions/download-artifact@v3

      - name: Generate Summary Report
        run: |
          echo "# ðŸ“‹ PACT Contract Testing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Consumer Contracts Generated" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -la pact-contracts/ || echo "No contracts found"
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Provider Verification Status" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All verifications completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [View in Pact Broker](http://localhost:9292)" >> $GITHUB_STEP_SUMMARY

